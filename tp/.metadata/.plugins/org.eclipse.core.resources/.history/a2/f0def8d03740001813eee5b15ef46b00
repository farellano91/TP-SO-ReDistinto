/*
 * cliente.c
 *
 *  Created on: 25/3/2018
 *      Author: utnso
 */

#include "cliente.h"

void saludo_inicial_planificador(int sockfd){
	//Recibo saludo del planificador
	void* buffer = malloc(sizeof(char)*200);
	char * mensajeSaludo = malloc(sizeof(char)*30);
	int numbytes = 0;
	if ((numbytes = recv(sockfd, buffer, 200, 0)) == -1) {
		perror("recv");
		printf("No se pudo recibir saludo del planificador\n");
		exit(1);
	}
	memcpy(bufferEnvio,mensajeSaludo,30);
	printf("Saludo planificador recibido: %s\n", mensajeSaludo);

	//Envio saludo al planificador (4bytes tamañio + mensaje posta)
	void* bufferEnvio = malloc(sizeof(char)*200);
	char * mensajeSaludo = malloc(sizeof(char)*30);
	strcpy(mensajeSaludo,"Hola planificador, soy un ESI");
	mensajeSaludo[strlen(mensajeSaludo)] = '\0';
	memcpy(bufferEnvio,mensajeSaludo,30);
	if(send(sockfd, bufferEnvio,sizeof(char)*30, 0)== -1){
		perror("recv");
		printf("No se pudo enviar saludo al planificador\n");
		exit(1);
	}

}



int conectar_planificador(){

	//busco la ip y puerto
	t_config* config = config_create("config.cfg");
	int PORT = config_get_int_value(config,"PUERTO_CONFIG_COORDINADOR");
	char * IP = malloc(sizeof(char)*100);
	strcpy(IP,config_get_string_value(config,"IP_CONFIG_COORDINADOR"));
	config_destroy(config);

	//Creamos un socket
	int sockfd;
    struct sockaddr_in their_addr; // información de la dirección de destino

    if ((sockfd = socket(AF_INET, SOCK_STREAM, 0)) == -1) {
        perror("socket");
        exit(1);
    }

    their_addr.sin_family = AF_INET;    // Ordenación de bytes de la máquina
    their_addr.sin_port = htons(PORT);  // short, Ordenación de bytes de la red
    their_addr.sin_addr.s_addr = inet_addr(IP);//toma la ip directo

    memset( &(their_addr.sin_zero) , 0 , 8);  // poner a cero el resto de la estructura

    if (connect(sockfd, (struct sockaddr *)&their_addr,
                                          sizeof(struct sockaddr)) == -1) {
        perror("connect");
        printf("No se pudo conectar\n");
        exit(1);
    }

    //manejo saludo
    saludo_inicial_planificador(sockfd);
    return(sockfd);
}
